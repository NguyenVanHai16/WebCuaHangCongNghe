{% extends "layout.html" %}
{% block title %}{{ product.name }} - TechMart{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/product_detail.css') }}?v=30">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    /* C·∫£i thi·ªán giao di·ªán n√∫t tr·∫£ l·ªùi */
    .reply-via-parent-btn {
        background-color: transparent;
        border: none;
        color: #007bff; /* M√†u xanh gi·ªëng n√∫t "Th√≠ch" */
        font-size: 14px;
        padding: 5px 10px;
        margin-left: 10px;
        cursor: pointer;
        transition: color 0.3s ease, background-color 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 5px; /* Kho·∫£ng c√°ch gi·ªØa icon v√† ch·ªØ */
    }

    .reply-via-parent-btn i {
        font-size: 14px;
    }

    .reply-via-parent-btn:hover {
        color: #0056b3; /* M√†u xanh ƒë·∫≠m h∆°n khi hover */
        background-color: rgba(0, 123, 255, 0.1); /* N·ªÅn m·ªù khi hover */
        border-radius: 4px;
    }

    .reply-via-parent-btn:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.3); /* Hi·ªáu ·ª©ng focus */
    }

    /* ƒê·∫£m b·∫£o n√∫t n·∫±m c√πng h√†ng v·ªõi n√∫t "Th√≠ch" */
    .comment-reactions {
        display: flex;
        align-items: center;
    }

    /* Style cho input s·ªë l∆∞·ª£ng */
    .quantity-input {
        width: 60px;
        padding: 5px;
        margin-right: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        text-align: center;
    }

    .quantity-selector {
        display: flex;
        align-items: center;
    }
</style>
{% endblock %}

{% block content %}
<section class="product-detail-section">
    <div class="container">
        <!-- Main Product Card -->
        <div class="product-card">
            <div class="product-image">
                <div class="label-container">
                    {% if (product.price is not none and product.discounted_price is not none and product.price|float > product.discounted_price|float) or product.is_sale %}
                    <span class="sale-label">Sale</span>
                    {% endif %}
                    {% if product.is_new %}
                    <span class="new-label">M·ªõi</span>
                    {% endif %}
                    {% if product.is_hot %}
                    <span class="hot-label">Hot</span>
                    {% endif %}
                    {% if product.is_limited %}
                    <span class="limited-label">Gi·ªõi h·∫°n</span>
                    {% endif %}
                    {% if product.is_bestseller %}
                    <span class="bestseller-label">B√°n ch·∫°y</span>
                    {% endif %}
                </div>
                {% if product.image %}
                <img src="{{ url_for('static', filename=product.image) }}" alt="{{ product.name }}" onerror="this.src='{{ url_for('static', filename='Uploads/sanpham/default.jpg') }}'">
                {% else %}
                <img src="{{ url_for('static', filename='Uploads/sanpham/default.jpg') }}" alt="{{ product.name }}">
                {% endif %}
            </div>
            <div class="product-info">
                <h1 class="product-title">{{ product.name }}</h1>
                <div class="product-price">
                    {% if product.price is not none %}
                        {% if product.discounted_price is not none and product.price|float > product.discounted_price|float %}
                        <span class="original-price">Gi√° g·ªëc: {{ '{:,.0f}'.format(product.price|float) }} ƒë</span>
                        <span class="discounted-price">Gi√° gi·∫£m: {{ '{:,.0f}'.format(product.discounted_price|float) }} ƒë</span>
                        {% else %}
                        <span class="normal-price">Gi√°: {{ '{:,.0f}'.format(product.price|float) }} ƒë</span>
                        {% endif %}
                    {% else %}
                    <span>Gi√° kh√¥ng kh·∫£ d·ª•ng</span>
                    {% endif %}
                </div>
                <p class="product-meta"><strong>Danh m·ª•c:</strong> {{ product.category.name }}</p>
                <p class="product-meta"><strong>Nh√† s·∫£n xu·∫•t:</strong> {{ product.manufacturer }}</p>
                <p class="product-meta"><strong>T·ªìn kho:</strong> {{ product.stock }}</p>
                <div class="product-description">
                    <strong>M√¥ t·∫£:</strong>
                    <p>{{ product.description }}</p>
                </div>
                <div class="product-rating">
                    <strong>ƒê√°nh gi√°:</strong>
                    {% set rating = product.rating | float | default(0) %}
                    {% set full_stars = rating | round(0, 'floor') | int %}
                    {% for i in range(5) %}
                    <span class="star {% if i < full_stars %}filled{% else %}empty{% endif %}">‚òÖ</span>
                    {% endfor %}
                    <span class="rating-count">({{ comments|length if comments else 0 }} ƒë√°nh gi√°)</span>
                </div>
                <div class="product-actions">
                    <div class="quantity-selector">
                        <input type="number" class="quantity-input" id="quantity" value="1" min="1" max="{{ product.stock }}">
                        <button class="btn btn-add-to-cart" data-product-id="{{ product.id }}">Th√™m v√†o gi·ªè h√†ng</button>
                    </div>
                    <button class="btn btn-primary btn-buy-now" data-product-id="{{ product.id }}">Mua ngay</button>
                    <button class="btn btn-primary review-toggle">ƒê√°nh gi√° ngay</button>
                </div>
            </div>
        </div>

        <!-- Reviews Section (Ch·ªâ ch·ª©a form g·ª≠i ƒë√°nh gi√°) -->
        <div class="reviews-section">
            <h2 class="section-title">G·ª≠i ƒë√°nh gi√°</h2>
            <div class="review-form">
                <h3>B·∫°n ƒë√°nh gi√° sao v·ªÅ s·∫£n ph·∫©m n√†y?</h3>
                <form id="review-form" action="{{ url_for('products.product_detail', product_id=product.id) }}" method="POST">
                    <div class="form-group">
                        <label>ƒê√°nh gi√° t·ªïng quan:</label>
                        <div class="rating-input" data-group="overall">
                            {% for i in range(5) %}
                            <span class="star empty" data-value="{{ i+1 }}">‚òÖ</span>
                            {% endfor %}
                            <input type="hidden" name="rating" id="rating-overall" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ƒê√°nh gi√° chi ti·∫øt:</label>
                        {% for criterion in ['Hi·ªáu nƒÉng', 'Th·ªùi l∆∞·ª£ng pin', 'Ch·∫•t l∆∞·ª£ng camera'] %}
                        <div class="criterion">
                            <span>{{ criterion }}</span>
                            <div class="rating-input" data-group="{{ criterion|lower|replace(' ', '-') }}">
                                {% for i in range(5) %}
                                <span class="star empty" data-value="{{ i+1 }}">‚òÖ</span>
                                {% endfor %}
                                <input type="hidden" name="criteria_{{ criterion|lower|replace(' ', '-') }}">
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="form-group">
                        <label for="content">Nh·∫≠n x√©t:</label>
                        <div class="textarea-container">
                            <textarea id="content" name="content" class="form-control" placeholder="Nh·∫≠p nh·∫≠n x√©t c·ªßa b·∫°n..." required></textarea>
                            <div class="emoji-picker">
                                <span class="emoji-toggle"><i class="far fa-smile"></i></span>
                                <div class="emoji-container">
                                    <span class="emoji" data-emoji="üëç" data-index="0">üëç</span>
                                    <span class="emoji" data-emoji="‚ù§Ô∏è" data-index="1">‚ù§Ô∏è</span>
                                    <span class="emoji" data-emoji="üòä" data-index="2">üòä</span>
                                    <span class="emoji" data-emoji="üëè" data-index="3">üëè</span>
                                    <span class="emoji" data-emoji="üéâ" data-index="4">üéâ</span>
                                    <span class="emoji" data-emoji="ü§î" data-index="5">ü§î</span>
                                    <span class="emoji" data-emoji="üòç" data-index="6">üòç</span>
                                    <span class="emoji" data-emoji="üî•" data-index="7">üî•</span>
                                    <span class="emoji" data-emoji="üòé" data-index="8">üòé</span>
                                    <span class="emoji" data-emoji="üòÇ" data-index="9">üòÇ</span>
                                    <span class="emoji" data-emoji="üò¢" data-index="10">üò¢</span>
                                    <span class="emoji" data-emoji="üòÆ" data-index="11">üòÆ</span>
                                    <span class="emoji" data-emoji="üôå" data-index="12">üôå</span>
                                    <span class="emoji" data-emoji="‚ú®" data-index="13">‚ú®</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">G·ª≠i ƒë√°nh gi√°</button>
                </form>
            </div>
        </div>

        <!-- Comments Section (Lu√¥n hi·ªÉn th·ªã) -->
        <div class="comments-section">
            <h2 class="section-title">B√¨nh lu·∫≠n</h2>
            <div class="review-list">
                {% if comments and comments|length > 0 %}
                {% for comment in comments %}
                <div class="review-item" id="comment-{{ comment.id }}">
                    <div class="review-header">
                        <div class="review-user">
                            <span class="avatar-mini">{{ comment.user.first_name[0] if comment.user and comment.user.first_name else 'U' }}</span>
                            <span class="user-name">{{ comment.user.first_name if comment.user and comment.user.first_name else 'Ng∆∞·ªùi d√πng' }}</span>
                            <span class="review-date">{{ comment.timestamp.strftime('%d/%m/%Y') if comment.timestamp else 'N/A' }}</span>
                        </div>
                        <div class="review-rating">
                            {% set review_rating = comment.score | int | default(0) %}
                            {% set full_stars = review_rating %}
                            {% for i in range(5) %}
                            <span class="star {% if i < full_stars %}filled{% else %}empty{% endif %}">‚òÖ</span>
                            {% endfor %}
                        </div>
                    </div>
                    <p class="review-comment">{{ comment.content }}</p>

                    <!-- Review reactions -->
                    <div class="review-reactions">
                        <div class="reaction-buttons">
                            <div class="reaction-btn-wrapper">
                                <button class="reaction-btn" data-comment-id="{{ comment.id }}">
                                    {% set user_reaction = comment.reactions | selectattr('user_id', 'equalto', current_user.id) | first %}
                                    {% if user_reaction %}
                                        <span class="reaction-emoji user-reaction">{{ user_reaction.emoji }}</span>
                                    {% else %}
                                        <i class="far fa-thumbs-up"></i> Th√≠ch
                                    {% endif %}
                                    <!-- Hi·ªÉn th·ªã c√°c bi·ªÉu t∆∞·ª£ng kh√°c (lo·∫°i tr·ª´ bi·ªÉu t∆∞·ª£ng c·ªßa ng∆∞·ªùi d√πng hi·ªán t·∫°i) -->
                                    <span class="reactions-display">
                                        {% set reaction_summary = {} %}
                                        {% for reaction in comment.reactions %}
                                            {% if reaction.user_id != current_user.id %}
                                                {% set count = reaction_summary[reaction.emoji] | default(0) + 1 %}
                                                {% set _ = reaction_summary.update({reaction.emoji: count}) %}
                                            {% endif %}
                                        {% endfor %}
                                        {% for emoji, count in reaction_summary.items() %}
                                            <span class="reaction-emoji" data-emoji="{{ emoji }}">{{ emoji }} <span class="reaction-count">{{ count }}</span></span>
                                        {% endfor %}
                                    </span>
                                </button>
                                <div class="emoji-list">
                                    <span class="emoji-option" data-emoji="üëç" data-index="0">üëç</span>
                                    <span class="emoji-option" data-emoji="‚ù§Ô∏è" data-index="1">‚ù§Ô∏è</span>
                                    <span class="emoji-option" data-emoji="üòä" data-index="2">üòä</span>
                                    <span class="emoji-option" data-emoji="üëè" data-index="3">üëè</span>
                                    <span class="emoji-option" data-emoji="üéâ" data-index="4">üéâ</span>
                                    <span class="emoji-option" data-emoji="ü§î" data-index="5">ü§î</span>
                                    <span class="emoji-option" data-emoji="üòç" data-index="6">üòç</span>
                                    <span class="emoji-option" data-emoji="üî•" data-index="7">üî•</span>
                                    <span class="emoji-option" data-emoji="üòé" data-index="8">üòé</span>
                                    <span class="emoji-option" data-emoji="üòÇ" data-index="9">üòÇ</span>
                                    <span class="emoji-option" data-emoji="üò¢" data-index="10">üò¢</span>
                                    <span class="emoji-option" data-emoji="üòÆ" data-index="11">üòÆ</span>
                                    <span class="emoji-option" data-emoji="üôå" data-index="12">üôå</span>
                                    <span class="emoji-option" data-emoji="‚ú®" data-index="13">‚ú®</span>
                                </div>
                            </div>
                            <button class="reply-btn" data-comment-id="{{ comment.id }}" data-username="{{ comment.user.first_name if comment.user and comment.user.first_name else 'Ng∆∞·ªùi d√πng' }}">
                                <i class="far fa-comment"></i> Tr·∫£ l·ªùi
                            </button>
                        </div>
                    </div>

                    <!-- Reply form for comments - initially hidden -->
                    <div class="reply-form" id="reply-form-{{ comment.id }}" style="display:none;">
                        <form class="comment-form" data-comment-id="{{ comment.id }}">
                            <input type="hidden" name="parent_id" value="{{ comment.id }}">
                            <div class="form-group">
                                <div class="textarea-container">
                                    <textarea class="form-control reply-text" name="content" placeholder="Vi·∫øt c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n..." required></textarea>
                                    <div class="emoji-picker">
                                        <span class="emoji-toggle"><i class="far fa-smile"></i></span>
                                        <div class="emoji-container">
                                            <span class="emoji" data-emoji="üëç" data-index="0">üëç</span>
                                            <span class="emoji" data-emoji="‚ù§Ô∏è" data-index="1">‚ù§Ô∏è</span>
                                            <span class="emoji" data-emoji="üòä" data-index="2">üòä</span>
                                            <span class="emoji" data-emoji="üëè" data-index="3">üëè</span>
                                            <span class="emoji" data-emoji="üéâ" data-index="4">üéâ</span>
                                            <span class="emoji" data-emoji="ü§î" data-index="5">ü§î</span>
                                            <span class="emoji" data-emoji="üòç" data-index="6">üòç</span>
                                            <span class="emoji" data-emoji="üî•" data-index="7">üî•</span>
                                            <span class="emoji" data-emoji="üòé" data-index="8">üòé</span>
                                            <span class="emoji" data-emoji="üòÇ" data-index="9">üòÇ</span>
                                            <span class="emoji" data-emoji="üò¢" data-index="10">üò¢</span>
                                            <span class="emoji" data-emoji="üòÆ" data-index="11">üòÆ</span>
                                            <span class="emoji" data-emoji="üôå" data-index="12">üôå</span>
                                            <span class="emoji" data-emoji="‚ú®" data-index="13">‚ú®</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary btn-sm">G·ª≠i</button>
                            <button type="button" class="btn btn-secondary btn-sm cancel-reply" data-comment-id="{{ comment.id }}">H·ªßy</button>
                        </form>
                    </div>

                    <!-- Comments section for replies -->
                    <div class="comments-section-inner" id="comments-{{ comment.id }}">
                        {% if comment.replies and comment.replies|length > 0 %}
                        {% for reply in comment.replies %}
                        <div class="comment-item" data-comment-id="{{ reply.id }}">
                            <div class="comment-header">
                                <span class="avatar-mini">{{ reply.user.first_name[0] if reply.user and reply.user.first_name else 'U' }}</span>
                                <span class="user-name">{{ reply.user.first_name if reply.user and reply.user.first_name else 'Ng∆∞·ªùi d√πng' }}</span>
                                <span class="comment-date">{{ reply.timestamp.strftime('%d/%m/%Y') if reply.timestamp else 'N/A' }}</span>
                            </div>
                            <p class="comment-text">{{ reply.content }}</p>
                            <div class="comment-reactions">
                                <div class="reaction-btn-wrapper">
                                    <button class="reaction-btn" data-comment-id="{{ reply.id }}">
                                        {% set user_reaction = reply.reactions | selectattr('user_id', 'equalto', current_user.id) | first %}
                                        {% if user_reaction %}
                                            <span class="reaction-emoji user-reaction">{{ user_reaction.emoji }}</span>
                                        {% else %}
                                            <i class="far fa-thumbs-up"></i>
                                        {% endif %}
                                        <!-- Hi·ªÉn th·ªã c√°c bi·ªÉu t∆∞·ª£ng kh√°c (lo·∫°i tr·ª´ bi·ªÉu t∆∞·ª£ng c·ªßa ng∆∞·ªùi d√πng hi·ªán t·∫°i) -->
                                        <span class="reactions-display">
                                            {% set reaction_summary = {} %}
                                            {% for reaction in reply.reactions %}
                                                {% if reaction.user_id != current_user.id %}
                                                    {% set count = reaction_summary[reaction.emoji] | default(0) + 1 %}
                                                    {% set _ = reaction_summary.update({reaction.emoji: count}) %}
                                                {% endif %}
                                            {% endfor %}
                                            {% for emoji, count in reaction_summary.items() %}
                                                <span class="reaction-emoji" data-emoji="{{ emoji }}">{{ emoji }} <span class="reaction-count">{{ count }}</span></span>
                                            {% endfor %}
                                        </span>
                                    </button>
                                    <div class="emoji-list">
                                        <span class="emoji-option" data-emoji="üëç" data-index="0">üëç</span>
                                        <span class="emoji-option" data-emoji="‚ù§Ô∏è" data-index="1">‚ù§Ô∏è</span>
                                        <span class="emoji-option" data-emoji="üòä" data-index="2">üòä</span>
                                        <span class="emoji-option" data-emoji="üëè" data-index="3">üëè</span>
                                        <span class="emoji-option" data-emoji="üéâ" data-index="4">üéâ</span>
                                        <span class="emoji-option" data-emoji="ü§î" data-index="5">ü§î</span>
                                        <span class="emoji-option" data-emoji="üòç" data-index="6">üòç</span>
                                        <span class="emoji-option" data-emoji="üî•" data-index="7">üî•</span>
                                        <span class="emoji-option" data-emoji="üòé" data-index="8">üòé</span>
                                        <span class="emoji-option" data-emoji="üòÇ" data-index="9">üòÇ</span>
                                        <span class="emoji-option" data-emoji="üò¢" data-index="10">üò¢</span>
                                        <span class="emoji-option" data-emoji="üòÆ" data-index="11">üòÆ</span>
                                        <span class="emoji-option" data-emoji="üôå" data-index="12">üôå</span>
                                        <span class="emoji-option" data-emoji="‚ú®" data-index="13">‚ú®</span>
                                    </div>
                                </div>
                                <!-- N√∫t tr·∫£ l·ªùi th√¥ng qua b√¨nh lu·∫≠n cha -->
                                <button class="reply-via-parent-btn" data-parent-id="{{ comment.id }}" data-username="{{ reply.user.first_name if reply.user and reply.user.first_name else 'Ng∆∞·ªùi d√πng' }}">
                                    <i class="far fa-comment"></i> Tr·∫£ l·ªùi
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <p class="no-replies">Ch∆∞a c√≥ tr·∫£ l·ªùi n√†o.</p>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p class="no-reviews">Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o.</p>
                {% endif %}
            </div>
        </div>

        <!-- Related Products -->
        <div class="related-products-section">
            <h2 class="section-title">S·∫£n ph·∫©m li√™n quan</h2>
            <div class="product-grid">
                {% if related_products %}
                {% for related in related_products %}
                <div class="related-product-card">
                    <a href="{{ url_for('products.product_detail', product_id=related.id) }}" class="product-card-link">
                        <div class="product-image">
                            <img src="{{ url_for('static', filename=related.image.lstrip('/static/')) if related.image else url_for('static', filename='Uploads/sanpham/default.jpg') }}"
                                 alt="{{ related.name }}"
                                 onerror="this.src='{{ url_for('static', filename='Uploads/sanpham/default.jpg') }}'">
                        </div>
                        <div class="product-details">
                            <h3 class="product-title">{{ related.name }}</h3>
                            <div class="product-price">
                                {% if related.price is not none %}
                                    {% if related.discounted_price is not none and related.price|float > related.discounted_price|float %}
                                    <span class="discounted-price">{{ '{:,.0f}'.format(related.discounted_price|float) }} ƒë</span>
                                    <span class="original-price">{{ '{:,.0f}'.format(related.price|float) }} ƒë</span>
                                    {% else %}
                                    <span class="normal-price">{{ '{:,.0f}'.format(related.price|float) }} ƒë</span>
                                    {% endif %}
                                {% else %}
                                <span>Gi√° kh√¥ng kh·∫£ d·ª•ng</span>
                                {% endif %}
                            </div>
                        </div>
                    </a>
                </div>
                {% endfor %}
                {% else %}
                <p class="no-products">Kh√¥ng c√≥ s·∫£n ph·∫©m li√™n quan.</p>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // X·ª≠ l√Ω n√∫t Th√™m v√†o gi·ªè h√†ng
    const addToCartButton = document.querySelector('.btn-add-to-cart');
    if (addToCartButton) {
        addToCartButton.addEventListener('click', function() {
            const productId = parseInt(this.getAttribute('data-product-id'));
            const quantityInput = document.querySelector('#quantity');
            const quantity = parseInt(quantityInput.value);
            const csrfToken = '{{ session["csrf_token"] }}';

            console.log('Adding to cart:', { productId, quantity, csrfToken });

            if (quantity < 1 || isNaN(quantity)) {
                alert('Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng h·ª£p l·ªá!');
                return;
            }

            if (quantity > parseInt(quantityInput.getAttribute('max'))) {
                alert('S·ªë l∆∞·ª£ng v∆∞·ª£t qu√° t·ªìn kho!');
                return;
            }

            const url = `/cart/add/${productId}`;
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: new URLSearchParams({
                    'quantity': quantity,
                    'csrf_token': csrfToken
                })
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.success) {
                    alert('S·∫£n ph·∫©m ƒë√£ ƒë∆∞·ª£c th√™m v√†o gi·ªè h√†ng!');
                } else {
                    alert(data.message || 'Kh√¥ng th·ªÉ th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng!');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('C√≥ l·ªói x·∫£y ra: ' + error.message);
            });
        });
    }

    // X·ª≠ l√Ω n√∫t Mua ngay
    const buyNowButton = document.querySelector('.btn-buy-now');
    if (buyNowButton) {
        buyNowButton.addEventListener('click', function() {
            const productId = parseInt(this.getAttribute('data-product-id'));
            const quantityInput = document.querySelector('#quantity');
            const quantity = parseInt(quantityInput.value);
            const csrfToken = '{{ session["csrf_token"] }}';

            if (quantity < 1 || isNaN(quantity)) {
                alert('Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng h·ª£p l·ªá!');
                return;
            }

            if (quantity > parseInt(quantityInput.getAttribute('max'))) {
                alert('S·ªë l∆∞·ª£ng v∆∞·ª£t qu√° t·ªìn kho!');
                return;
            }

            console.log('Buying now:', { productId, quantity });

            fetch(`/cart/buy-now/${productId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: new URLSearchParams({
                    'quantity': quantity,
                    'csrf_token': csrfToken
                })
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.success) {
                    window.location.href = '{{ url_for("cart.checkout") }}';
                } else {
                    alert(data.message || 'Kh√¥ng th·ªÉ th·ª±c hi·ªán mua ngay!');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('C√≥ l·ªói x·∫£y ra: ' + error.message);
            });
        });
    }

    // Toggle reviews section
    const reviewToggle = document.querySelector('.review-toggle');
    const reviewsSection = document.querySelector('.reviews-section');
    if (reviewToggle && reviewsSection) {
        reviewToggle.addEventListener('click', function() {
            reviewsSection.classList.toggle('visible');
            if (reviewsSection.classList.contains('visible')) {
                reviewsSection.scrollIntoView({ behavior: 'smooth' });
            }
        });
    }

    // Rating input functionality
    const ratingInputs = document.querySelectorAll('.rating-input');
    ratingInputs.forEach(input => {
        const stars = input.querySelectorAll('.star');
        stars.forEach(star => {
            star.addEventListener('click', function() {
                const value = parseInt(this.getAttribute('data-value'));
                stars.forEach(s => {
                    const starValue = parseInt(s.getAttribute('data-value'));
                    if (starValue <= value) {
                        s.classList.remove('empty');
                        s.classList.add('filled');
                    } else {
                        s.classList.remove('filled');
                        s.classList.add('empty');
                    }
                });

                const group = input.getAttribute('data-group');
                let hiddenInput = input.querySelector(`input[name="${group === 'overall' ? 'rating' : 'criteria_' + group}"]`);
                if (!hiddenInput) {
                    hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = group === 'overall' ? 'rating' : 'criteria_' + group;
                    input.appendChild(hiddenInput);
                }
                hiddenInput.value = value;
            });

            star.addEventListener('mouseover', function() {
                const hoverValue = parseInt(this.getAttribute('data-value'));
                stars.forEach(s => {
                    const starValue = parseInt(s.getAttribute('data-value'));
                    if (starValue <= hoverValue) {
                        s.classList.add('hover');
                    } else {
                        s.classList.remove('hover');
                    }
                });
            });

            star.addEventListener('mouseout', function() {
                stars.forEach(s => {
                    s.classList.remove('hover');
                });
            });
        });
    });

    // Emoji picker functionality (textarea)
    function attachEmojiListeners() {
        const emojiToggles = document.querySelectorAll('.emoji-toggle');
        emojiToggles.forEach(toggle => {
            toggle.removeEventListener('click', handleEmojiToggleClick);
            toggle.addEventListener('click', handleEmojiToggleClick);
        });

        const emojis = document.querySelectorAll('.emoji');
        emojis.forEach(emoji => {
            emoji.removeEventListener('click', handleEmojiClick);
            emoji.addEventListener('click', handleEmojiClick);
        });

        document.removeEventListener('click', handleClickOutsideEmoji);
        document.addEventListener('click', handleClickOutsideEmoji);
    }

    function handleEmojiToggleClick() {
        const container = this.nextElementSibling;
        container.classList.toggle('show');
    }

    function handleEmojiClick() {
        const emojiChar = this.getAttribute('data-emoji');
        const container = this.closest('.emoji-picker');
        const textarea = container.parentElement.querySelector('textarea');

        if (textarea) {
            const cursorPos = textarea.selectionStart;
            const textBefore = textarea.value.substring(0, cursorPos);
            const textAfter = textarea.value.substring(cursorPos);
            textarea.value = textBefore + emojiChar + textAfter;
            textarea.selectionStart = cursorPos + emojiChar.length;
            textarea.selectionEnd = cursorPos + emojiChar.length;

            const inputEvent = new Event('input', { bubbles: true });
            textarea.dispatchEvent(inputEvent);

            textarea.focus();
        }

        container.classList.remove('show');
    }

    function handleClickOutsideEmoji(e) {
        const emojiContainers = document.querySelectorAll('.emoji-container');
        emojiContainers.forEach(container => {
            const toggle = container.previousElementSibling;
            if (!toggle.contains(e.target) && !container.contains(e.target)) {
                container.classList.remove('show');
            }
        });
    }

    // Reaction emoji list functionality (click to show)
    function attachReactionButtonListeners() {
        const reactionButtons = document.querySelectorAll('.reaction-btn');
        reactionButtons.forEach(button => {
            button.removeEventListener('click', handleReactionButtonClick);
            button.addEventListener('click', handleReactionButtonClick);
        });

        const emojiOptions = document.querySelectorAll('.emoji-option');
        emojiOptions.forEach(option => {
            option.removeEventListener('click', handleEmojiOptionClick);
            option.addEventListener('click', handleEmojiOptionClick);
        });

        document.removeEventListener('click', handleClickOutsideEmojiList);
        document.addEventListener('click', handleClickOutsideEmojiList);
    }

    function handleReactionButtonClick(e) {
        e.preventDefault();
        const emojiList = this.nextElementSibling;
        if (emojiList) {
            document.querySelectorAll('.emoji-list').forEach(list => {
                if (list !== emojiList) {
                    list.classList.remove('show');
                }
            });
            emojiList.classList.toggle('show');
        }
    }

    function handleEmojiOptionClick() {
        const emoji = this.getAttribute('data-emoji');
        const commentId = this.closest('.reaction-btn-wrapper').querySelector('.reaction-btn').getAttribute('data-comment-id');
        console.log('Sending reaction:', { commentId, emoji });
        fetch('{{ url_for("products.product_detail", product_id=product.id) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `emoji=${encodeURIComponent(emoji)}&comment_id=${commentId}`
        })
        .then(response => {
            console.log('Reaction response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Reaction response data:', data);
            if (data.success) {
                const button = document.querySelector(`.reaction-btn[data-comment-id="${commentId}"]`);
                const reactionsDisplay = button.querySelector('.reactions-display');
                reactionsDisplay.innerHTML = '';
                const userEmojiSpan = document.createElement('span');
                userEmojiSpan.className = 'reaction-emoji user-reaction';
                userEmojiSpan.textContent = emoji;
                button.innerHTML = '';
                button.appendChild(userEmojiSpan);

                for (const [emoji, count] of Object.entries(data.reaction_summary)) {
                    if (emoji !== data.reaction_emoji) {
                        const emojiSpan = document.createElement('span');
                        emojiSpan.className = 'reaction-emoji';
                        emojiSpan.setAttribute('data-emoji', emoji);
                        emojiSpan.innerHTML = `${emoji} <span class="reaction-count">${count}</span>`;
                        reactionsDisplay.appendChild(emojiSpan);
                    }
                }
                button.appendChild(reactionsDisplay);

                if (data.action === 'added') {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                    button.innerHTML = '<i class="far fa-thumbs-up"></i> Th√≠ch';
                    button.appendChild(reactionsDisplay);
                }

                const emojiList = button.nextElementSibling;
                if (emojiList) {
                    emojiList.classList.remove('show');
                }
            } else {
                alert(data.message || 'C√≥ l·ªói khi g·ª≠i ph·∫£n ·ª©ng!');
            }
        })
        .catch(error => {
            console.error('Reaction error:', error);
            alert('C√≥ l·ªói khi g·ª≠i ph·∫£n ·ª©ng: ' + error.message);
        });
    }

    function handleClickOutsideEmojiList(e) {
        const emojiLists = document.querySelectorAll('.emoji-list');
        emojiLists.forEach(list => {
            const button = list.previousElementSibling;
            if (!button.contains(e.target) && !list.contains(e.target)) {
                list.classList.remove('show');
            }
        });
    }

    // Handle reply buttons for top-level comments
    function attachReplyButtonListeners() {
        const replyButtons = document.querySelectorAll('.reply-btn');
        replyButtons.forEach(button => {
            button.removeEventListener('click', handleReplyClick);
            button.addEventListener('click', handleReplyClick);
        });

        // N√∫t tr·∫£ l·ªùi th√¥ng qua b√¨nh lu·∫≠n cha
        const replyViaParentButtons = document.querySelectorAll('.reply-via-parent-btn');
        replyViaParentButtons.forEach(button => {
            button.removeEventListener('click', handleReplyViaParentClick);
            button.addEventListener('click', handleReplyViaParentClick);
        });
    }

    function handleReplyClick() {
        const commentId = this.getAttribute('data-comment-id');
        const username = this.getAttribute('data-username');
        const replyForm = document.getElementById(`reply-form-${commentId}`);
        if (replyForm) {
            document.querySelectorAll('.reply-form').forEach(form => {
                if (form !== replyForm) {
                    form.style.display = 'none';
                }
            });
            replyForm.style.display = 'block';
            const textarea = replyForm.querySelector('textarea');
            if (textarea) {
                if (!textarea.value.trim().startsWith(`@${username}`)) {
                    textarea.value = `@${username} `;
                }
                textarea.focus();
                textarea.setSelectionRange(textarea.value.length, textarea.value.length);
            }
            replyForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    function handleReplyViaParentClick() {
        const parentId = this.getAttribute('data-parent-id');
        const username = this.getAttribute('data-username');
        const replyForm = document.getElementById(`reply-form-${parentId}`);
        if (replyForm) {
            document.querySelectorAll('.reply-form').forEach(form => {
                if (form !== replyForm) {
                    form.style.display = 'none';
                }
            });
            replyForm.style.display = 'block';
            const textarea = replyForm.querySelector('textarea');
            if (textarea) {
                if (!textarea.value.trim().startsWith(`@${username}`)) {
                    textarea.value = `@${username} `;
                }
                textarea.focus();
                textarea.setSelectionRange(textarea.value.length, textarea.value.length);
            }
            replyForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    // Handle cancel reply buttons
    function attachCancelReplyListeners() {
        const cancelButtons = document.querySelectorAll('.cancel-reply');
        cancelButtons.forEach(button => {
            button.removeEventListener('click', handleCancelReplyClick);
            button.addEventListener('click', handleCancelReplyClick);
        });
    }

    function handleCancelReplyClick() {
        const commentId = this.getAttribute('data-comment-id');
        const replyForm = document.getElementById(`reply-form-${commentId}`);
        if (replyForm) {
            replyForm.style.display = 'none';
            const textarea = replyForm.querySelector('textarea');
            if (textarea) {
                textarea.value = '';
            }
        }
    }

    // Handle review form submission (with DOM manipulation)
    const reviewForm = document.getElementById('review-form');
    if (reviewForm) {
        reviewForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            console.log('Sending review:', Object.fromEntries(formData));
            fetch(this.action, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log('Review response status:', response.status);
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(`HTTP ${response.status}: ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Review response data:', data);
                if (data.success) {
                    const comment = data.comment;
                    const reviewList = document.querySelector('.review-list');
                    const noReviews = reviewList.querySelector('.no-reviews');

                    if (noReviews) {
                        noReviews.remove();
                    }

                    const commentHtml = `
                        <div class="review-item" id="comment-${comment.id}">
                            <div class="review-header">
                                <div class="review-user">
                                    <span class="avatar-mini">${comment.user.first_name[0]}</span>
                                    <span class="user-name">${comment.user.first_name}</span>
                                    <span class="review-date">${comment.timestamp}</span>
                                </div>
                                <div class="review-rating">
                                    ${Array(5).fill().map((_, i) => `<span class="star ${i < comment.score ? 'filled' : 'empty'}">‚òÖ</span>`).join('')}
                                </div>
                            </div>
                            <p class="review-comment">${comment.content}</p>
                            <div class="review-reactions">
                                <div class="reaction-buttons">
                                    <div class="reaction-btn-wrapper">
                                        <button class="reaction-btn" data-comment-id="${comment.id}">
                                            <i class="far fa-thumbs-up"></i> Th√≠ch
                                            <span class="reactions-display"></span>
                                        </button>
                                        <div class="emoji-list">
                                            <span class="emoji-option" data-emoji="üëç" data-index="0">üëç</span>
                                            <span class="emoji-option" data-emoji="‚ù§Ô∏è" data-index="1">‚ù§Ô∏è</span>
                                            <span class="emoji-option" data-emoji="üòä" data-index="2">üòä</span>
                                            <span class="emoji-option" data-emoji="üëè" data-index="3">üëè</span>
                                            <span class="emoji-option" data-emoji="üéâ" data-index="4">üéâ</span>
                                            <span class="emoji-option" data-emoji="ü§î" data-index="5">ü§î</span>
                                            <span class="emoji-option" data-emoji="üòç" data-index="6">üòç</span>
                                            <span class="emoji-option" data-emoji="üî•" data-index="7">üî•</span>
                                            <span class="emoji-option" data-emoji="üòé" data-index="8">üòé</span>
                                            <span class="emoji-option" data-emoji="üòÇ" data-index="9">üòÇ</span>
                                            <span class="emoji-option" data-emoji="üò¢" data-index="10">üò¢</span>
                                            <span class="emoji-option" data-emoji="üòÆ" data-index="11">üòÆ</span>
                                            <span class="emoji-option" data-emoji="üôå" data-index="12">üôå</span>
                                            <span class="emoji-option" data-emoji="‚ú®" data-index="13">‚ú®</span>
                                        </div>
                                    </div>
                                    <button class="reply-btn" data-comment-id="${comment.id}" data-username="${comment.user.first_name}">
                                        <i class="far fa-comment"></i> Tr·∫£ l·ªùi
                                    </button>
                                </div>
                            </div>
                            <div class="reply-form" id="reply-form-${comment.id}" style="display:none;">
                                <form class="comment-form" data-comment-id="${comment.id}">
                                    <input type="hidden" name="parent_id" value="${comment.id}">
                                    <div class="form-group">
                                        <div class="textarea-container">
                                            <textarea class="form-control reply-text" name="content" placeholder="Write your response..." required></textarea>
                                        <div class="emoji-picker">
                                            <span class="emoji-toggle"><i class="far fa-smile"></i></span>
                                            <div class="emoji-container">
                                                <span class="emoji" data-emoji="üëç" data-index="0">üëç</span>
                                                <span class="emoji" data-emoji="‚ù§Ô∏è" data-index="1">‚ù§Ô∏è</span>
                                                <span class="emoji" data-emoji="üòä" data-index="2">üòä</span>
                                                <span class="emoji" data-emoji="üëè" data-index="3">üëè</span>
                                                <span class="emoji" data-emoji="üéâ" data-index="4">üéâ</span>
                                                <span class="emoji" data-emoji="ü§î" data-index="5">ü§î</span>
                                                <span class="emoji" data-emoji="üòç" data-index="6">üòç</span>
                                                <span class="emoji" data-emoji="üî•" data-index="7">üî•</span>
                                                <span class="emoji" data-emoji="üòé" data-index="8">üòé</span>
                                                <span class="emoji" data-emoji="üòÇ" data-index="9">üòÇ</span>
                                                <span class="emoji" data-emoji="üò¢" data-index="10">üò¢</span>
                                                <span class="emoji" data-emoji="üòÆ" data-index="11">üòÆ</span>
                                                <span class="emoji" data-emoji="üôå" data-index="12">üôå</span>
                                                <span class="emoji" data-emoji="‚ú®" data-index="13">‚ú®</span>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary btn-sm">Submit</button>
                                    <button type="button" class="btn btn-secondary btn-sm cancel-reply" data-comment-id="${comment.id}">Cancel</button>
                                </form>
                            </div>
                            <div class="comments-section-inner" id="comments-${comment.id}"></div>
                        </div>
                    `;

                    reviewList.insertAdjacentHTML('afterbegin', commentHtml);

                    this.reset();
                    const stars = this.querySelectorAll('.rating-input .star');
                    stars.forEach(star => {
                        star.classList.remove('filled');
                        star.classList.add('empty');
                    });
                    const hiddenInputs = this.querySelectorAll('input[type="hidden"]');
                    hiddenInputs.forEach(input => input.value = '');

                    attachReplyButtonListeners();
                    attachReactionButtonListeners();
                    attachEmojiListeners();
                    attachCancelReplyListeners();
                    attachCommentFormListeners();
                } else {
                    alert(data.message || 'C√≥ l·ªói khi g·ª≠i ƒë√°nh gi√°!');
                }
            })
            .catch(error => {
                console.error('Review error:', error);
                alert('C√≥ l·ªói khi g·ª≠i ƒë√°nh gi√°: ' + error.message);
            });
        });
    }

    // Handle comment form submission (reply form with DOM manipulation)
    function attachCommentFormListeners() {
        const commentForms = document.querySelectorAll('.comment-form');
        commentForms.forEach(form => {
            form.removeEventListener('submit', handleCommentFormSubmit);
            form.addEventListener('submit', handleCommentFormSubmit);
        });
    }

    function handleCommentFormSubmit(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const commentId = this.getAttribute('data-comment-id');
        console.log('Sending comment:', Object.fromEntries(formData));
        fetch('{{ url_for("products.product_detail", product_id=product.id) }}', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            console.log('Comment response status:', response.status);
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`HTTP ${response.status}: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Comment response data:', data);
            if (data.success) {
                const comment = data.comment;
                let parentContainer = document.getElementById(`comments-${commentId}`);
                const replyForm = document.getElementById(`reply-form-${commentId}`);

                // N·∫øu parentContainer kh√¥ng t·ªìn t·∫°i, t·∫°o m·ªõi v√† th√™m v√†o DOM
                if (!parentContainer) {
                    const parentComment = document.getElementById(`comment-${commentId}`);
                    if (parentComment) {
                        const newContainer = document.createElement('div');
                        newContainer.className = 'comments-section-inner';
                        newContainer.id = `comments-${commentId}`;
                        parentComment.appendChild(newContainer);
                        parentContainer = newContainer;
                    } else {
                        console.error(`Parent comment with ID comment-${commentId} not found`);
                        alert('Kh√¥ng t√¨m th·∫•y b√¨nh lu·∫≠n cha ƒë·ªÉ th√™m tr·∫£ l·ªùi!');
                        return;
                    }
                }

                const replyHtml = `
                    <div class="comment-item" data-comment-id="${comment.id}">
                        <div class="comment-header">
                            <span class="avatar-mini">${comment.user.first_name[0]}</span>
                            <span class="user-name">${comment.user.first_name}</span>
                            <span class="comment-date">${comment.timestamp}</span>
                        </div>
                        <p class="comment-text">${comment.content}</p>
                        <div class="comment-reactions">
                            <div class="reaction-btn-wrapper">
                                <button class="reaction-btn" data-comment-id="${comment.id}">
                                    <i class="far fa-thumbs-up"></i>
                                    <span class="reactions-display"></span>
                                </button>
                                <div class="emoji-list">
                                    <span class="emoji-option" data-emoji="üëç" data-index="0">üëç</span>
                                    <span class="emoji-option" data-emoji="‚ù§Ô∏è" data-index="1">‚ù§Ô∏è</span>
                                    <span class="emoji-option" data-emoji="üòä" data-index="2">üòä</span>
                                    <span class="emoji-option" data-emoji="üëè" data-index="3">üëè</span>
                                    <span class="emoji-option" data-emoji="üéâ" data-index="4">üéâ</span>
                                    <span class="emoji-option" data-emoji="ü§î" data-index="5">ü§î</span>
                                    <span class="emoji-option" data-emoji="üòç" data-index="6">üòç</span>
                                    <span class="emoji-option" data-emoji="üî•" data-index="7">üî•</span>
                                    <span class="emoji-option" data-emoji="üòé" data-index="8">üòé</span>
                                    <span class="emoji-option" data-emoji="üòÇ" data-index="9">üòÇ</span>
                                    <span class="emoji-option" data-emoji="üò¢" data-index="10">üò¢</span>
                                    <span class="emoji-option" data-emoji="üòÆ" data-index="11">üòÆ</span>
                                    <span class="emoji-option" data-emoji="üôå" data-index="12">üôå</span>
                                    <span class="emoji-option" data-emoji="‚ú®" data-index="13">‚ú®</span>
                                </div>
                            </div>
                            <button class="reply-via-parent-btn" data-parent-id="${commentId}" data-username="${comment.user.first_name}">
                                <i class="far fa-comment"></i> Tr·∫£ l·ªùi
                            </button>
                        </div>
                    </div>
                `;

                parentContainer.insertAdjacentHTML('beforeend', replyHtml);

                this.querySelector('textarea').value = '';
                this.style.display = 'none';

                attachReplyButtonListeners();
                attachReactionButtonListeners();
                attachEmojiListeners();
                attachCancelReplyListeners();
                attachCommentFormListeners();
            } else {
                alert(data.message || 'C√≥ l·ªói khi g·ª≠i b√¨nh lu·∫≠n!');
            }
        })
        .catch(error => {
            console.error('Comment error:', error);
            alert('C√≥ l·ªói khi g·ª≠i b√¨nh lu·∫≠n: ' + error.message);
        });
    }

    // G·∫Øn s·ª± ki·ªán cho c√°c form b√¨nh lu·∫≠n ban ƒë·∫ßu
    attachCommentFormListeners();
    attachReactionButtonListeners();
    attachEmojiListeners();
    attachReplyButtonListeners();
    attachCancelReplyListeners();
});
</script>
{% endblock %}